<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Planning Poker</title>
</head>
<style>
    div {border-bottom: 1px dashed gray; margin: 20px;}
</style>
<body>
    <div>
        <button id="connect">Connect</button>
        <input type="text" id="connect-name">
    </div>
    <div>
        <button id="create">Create Room</button>
        <input type="text" id="create-name">        
    </div>
    <div>
        <button id="join">Join Room</button>
        <input type="text" id="join-rid">
    </div>
    <div>
        <button id="leave">Leave Room</button>
        <input type="text" id="leave-rid">
    </div>
    <div>
        <button id="destroy">Destroy Room</button>
        <input type="text" id="destroy-rid">
    </div>
    <div>
        <button id="newstory">New Story</button>
        <input type="text" id="newstory-rid">
        <input type="text" id="newstory-name">
    </div>
    <div>
        <button id="vote">Vote</button>
        <input type="text" id="vote-rid">
        <input type="text" id="vote-card">
    </div>
    <pre id="log"></pre>
    <script>
        const connect = document.getElementById("connect");
        const connectName = document.getElementById("connect-name");

        const create = document.getElementById("create");
        const createName = document.getElementById("create-name");

        const join = document.getElementById("join");
        const joinRid = document.getElementById("join-rid");

        const leave = document.getElementById("leave");
        const leaveRid = document.getElementById("leave-rid");

        const destroy = document.getElementById("destroy");
        const destroyRid = document.getElementById("destroy-rid");

        const newStory = document.getElementById("newstory");
        const newStoryName = document.getElementById("newstory-name");
        const newStoryRid = document.getElementById("newstory-rid");

        const vote = document.getElementById("vote");
        const voteCard = document.getElementById("vote-card");
        const voteRid = document.getElementById("vote-rid");

        const log = document.getElementById("log");
        
        let connectHandler = evt => {
            const name = connectName.value;
            ws = webSock(name);
            connect.removeEventListener('click', connectHandler);
        };
        connect.addEventListener('click', connectHandler);
        function webSock(name) {
            var ws = new WebSocket("ws://localhost:3000");
            ws.onopen = evt => ws.send(JSON.stringify({"tag":"Connect","contents":name}));
            ws.onmessage = evt => {
                var m = evt.data;
                log.textContent = JSON.stringify(JSON.parse(m), null, 4) + "\n\n" + log.textContent ;
            };
            ws.onclose = function () {
                log.textContent = ("ws closed" + "\n") + log.textContent;
            };
            window.onbeforeunload = evt => {
                socket.close();
            };
            create.addEventListener('click', evt => {
                ws.send(JSON.stringify({
                    tag: "CreateRoom",
                    contents:[createName.value, "STORY", ["Infinity", "Coffee", "Unknown"], false]
                }));
            });
            join.addEventListener('click', evt => {
                ws.send(JSON.stringify({
                    tag: "JoinRoom",
                    contents:parseInt(joinRid.value, 10)
                }));
            });
            leave.addEventListener('click', evt => {
                ws.send(JSON.stringify({
                    tag: "LeaveRoom",
                    contents:parseInt(leaveRid.value, 10)
                }));
            });
            destroy.addEventListener('click', evt => {
                ws.send(JSON.stringify({
                    tag: "DestroyRoom",
                    contents:parseInt(destroyRid.value, 10)
                }));
            })
            newStory.addEventListener('click', evt => {
                ws.send(JSON.stringify({
                    tag: "CreateNewStory",
                    contents:[parseInt(newStoryRid.value, 10), newStoryName.value]
                }));
            })
            vote.addEventListener('click', evt => {
                ws.send(JSON.stringify({
                    tag: "Vote",
                    contents:[parseInt(voteRid.value, 10), voteCard.value]
                }));
            })
        }
        // {"tag":"Connect","contents":"foobar"}
        // {"tag":"CreateRoom","contents":["baz","QUX",["Infinity", "Coffee", "Unknown"],false]}
        // {"tag":"DestroyRoom","contents":30}
        // {"tag":"JoinRoom","contents":23}
        // {"tag":"Connected","contents":23}
        // {"tag":"Disconnect"}
        // {"tag":"Disconnected","contents":232}
        // {"tag":"NewStory"}
        // {"tag":"Vote","contents":"Three"}
    </script>
</body>
</html>
